name: Documentation Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  docstring-validation:
    name: Docstring Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pydocstyle interrogate
          pip install -r requirements.txt

      - name: Check docstring style with pydocstyle
        run: |
          pydocstyle core/ api/ db/ --convention=google --count || true > pydocstyle-report.txt
          cat pydocstyle-report.txt

      - name: Check docstring coverage with interrogate
        run: |
          interrogate core/ api/ db/ --verbose --ignore-init-method \
                     --ignore-magic --ignore-module --ignore-private \
                     --output=interrogate-report.txt || true
          cat interrogate-report.txt

      - name: Generate docstring summary
        run: |
          echo "Docstring Validation Summary" > docstring-summary.txt
          echo "===========================" >> docstring-summary.txt
          echo "Date: $(date)" >> docstring-summary.txt
          echo "" >> docstring-summary.txt
          echo "Validation performed:" >> docstring-summary.txt
          echo "- Docstring style consistency (pydocstyle)" >> docstring-summary.txt
          echo "- Docstring coverage analysis (interrogate)" >> docstring-summary.txt
          echo "" >> docstring-summary.txt

      - name: Upload docstring reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docstring-reports
          path: |
            pydocstyle-report.txt
            interrogate-report.txt
            docstring-summary.txt

  markdown-validation:
    name: Markdown Documentation Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install markdown tools
        run: |
          npm install -g markdownlint-cli markdown-link-check

      - name: Validate markdown files
        run: |
          # Check markdown syntax and style
          markdownlint docs/ README.md --output markdown-lint-report.txt || true
          cat markdown-lint-report.txt
          
          # Check for broken links
          find docs/ -name "*.md" -exec markdown-link-check {} \; > markdown-links-report.txt 2>&1 || true
          markdown-link-check README.md >> markdown-links-report.txt 2>&1 || true
          cat markdown-links-report.txt

      - name: Upload markdown reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: markdown-reports
          path: |
            markdown-lint-report.txt
            markdown-links-report.txt

  documentation-consistency:
    name: Documentation Consistency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check API documentation consistency
        run: |
          cat > check_api_docs.py << 'EOF'
          import ast
          import os
          import re
          
          def check_api_documentation():
              """Check if API endpoints have corresponding documentation."""
              api_file = "api/sfm_api.py"
              issues = []
              
              if not os.path.exists(api_file):
                  return ["API file not found"]
              
              with open(api_file, 'r') as f:
                  content = f.read()
              
              # Find all route decorators
              routes = re.findall(r'@app\.(get|post|put|delete|patch)\(["\']([^"\']+)["\']', content)
              
              for method, route in routes:
                  # Check if route has docstring
                  pattern = f'@app\\.{method}\\(["\']' + re.escape(route) + '["\'].*?def\\s+\\w+\\([^)]*\\):(.*?)(?=def|@|$)'
                  match = re.search(pattern, content, re.DOTALL)
                  if match:
                      func_body = match.group(1)
                      if '"""' not in func_body and "'''" not in func_body:
                          issues.append(f"Route {method.upper()} {route} missing docstring")
              
              return issues
          
          issues = check_api_documentation()
          with open("api-docs-report.txt", "w") as f:
              f.write("API Documentation Consistency Check\n")
              f.write("===================================\n\n")
              if issues:
                  f.write("Issues found:\n")
                  for issue in issues:
                      f.write(f"- {issue}\n")
              else:
                  f.write("No issues found - all API endpoints have documentation\n")
          EOF
          
          python check_api_docs.py

      - name: Check enum documentation consistency
        run: |
          cat > check_enum_docs.py << 'EOF'
          import ast
          import os
          
          def check_enum_documentation():
              """Check if enums have consistent documentation."""
              enum_file = "core/sfm_enums.py"
              issues = []
              
              if not os.path.exists(enum_file):
                  return ["Enum file not found"]
              
              with open(enum_file, 'r') as f:
                  content = f.read()
              
              # Simple check for class documentation
              enum_classes = []
              lines = content.split('\n')
              for i, line in enumerate(lines):
                  if 'class ' in line and 'Enum' in line:
                      class_name = line.split('class ')[1].split('(')[0].strip()
                      enum_classes.append(class_name)
                      
                      # Check if next lines contain docstring
                      found_docstring = False
                      for j in range(i+1, min(i+10, len(lines))):
                          if '"""' in lines[j] or "'''" in lines[j]:
                              found_docstring = True
                              break
                          if lines[j].strip() and not lines[j].strip().startswith('#'):
                              break
                      
                      if not found_docstring:
                          issues.append(f"Enum class {class_name} missing docstring")
              
              return issues, enum_classes
          
          issues, enum_classes = check_enum_documentation()
          with open("enum-docs-report.txt", "w") as f:
              f.write("Enum Documentation Consistency Check\n")
              f.write("===================================\n\n")
              f.write(f"Total enum classes found: {len(enum_classes)}\n\n")
              if issues:
                  f.write("Issues found:\n")
                  for issue in issues:
                      f.write(f"- {issue}\n")
              else:
                  f.write("No issues found - all enum classes have documentation\n")
          EOF
          
          python check_enum_docs.py

      - name: Check README consistency
        run: |
          echo "README Consistency Check" > readme-consistency-report.txt
          echo "=======================" >> readme-consistency-report.txt
          echo "" >> readme-consistency-report.txt
          
          # Check if README mentions all main modules
          echo "Checking if README mentions core modules..." >> readme-consistency-report.txt
          MODULES=("sfm_models" "sfm_enums" "sfm_service" "sfm_api" "sfm_dao" "sfm_query")
          for module in "${MODULES[@]}"; do
              if grep -q "$module" README.md; then
                  echo "✓ $module mentioned in README" >> readme-consistency-report.txt
              else
                  echo "✗ $module NOT mentioned in README" >> readme-consistency-report.txt
              fi
          done
          
          echo "" >> readme-consistency-report.txt
          echo "Checking for outdated information..." >> readme-consistency-report.txt
          
          # Check Python version consistency
          README_PYTHON=$(grep -o "Python [0-9]\+\.[0-9]\+" README.md | head -1)
          SETUP_PYTHON=$(grep -o "python_requires.*[0-9]\+\.[0-9]\+" setup.py | head -1)
          echo "Python version in README: $README_PYTHON" >> readme-consistency-report.txt
          echo "Python version in setup.py: $SETUP_PYTHON" >> readme-consistency-report.txt

      - name: Upload consistency reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: consistency-reports
          path: |
            api-docs-report.txt
            enum-docs-report.txt
            readme-consistency-report.txt

  documentation-build:
    name: Documentation Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install documentation tools
        run: |
          python -m pip install --upgrade pip
          pip install sphinx sphinx-rtd-theme
          pip install -r requirements.txt

      - name: Generate API documentation
        run: |
          mkdir -p docs/build
          sphinx-apidoc -o docs/build core/ api/ db/
          echo "API documentation generated successfully" > docs-build-report.txt
          echo "Generated files:" >> docs-build-report.txt
          ls -la docs/build/ >> docs-build-report.txt

      - name: Upload documentation build
        uses: actions/upload-artifact@v4
        with:
          name: documentation-build
          path: |
            docs/build/
            docs-build-report.txt